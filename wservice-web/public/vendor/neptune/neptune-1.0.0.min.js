/*! neptune  2015-11-11*/
angular.module("ui.neptune",["ui.neptune.tpls","ui.neptune.service","ui.neptune.validator","ui.neptune.filter","ui.neptune.directive"]),angular.module("ui.neptune.service",["ui.neptune.service.resource","ui.neptune.service.datatableStore","ui.neptune.service.formStore"]),angular.module("ui.neptune.validator",["ui.neptune.validator.number2date","ui.neptune.validator.bizValidator"]),angular.module("ui.neptune.filter",["ui.neptune.filter.bizFilter"]),angular.module("ui.neptune.directive",["ui.neptune.directive.datatable","ui.neptune.directive.selectTree","ui.neptune.directive.form"]),angular.module("ui.neptune.service.datatableStore",[]).provider("nptDatatableStore",function(){this.datatables={},this.datatable=function(a,b){if(b||(b=a,a=b.name),!a)throw new Error("datatable must have a name.");return this.datatable.name=a,this.datatables[a]=b,this},this.$get=function(){var a=this,b={datatable:function(b,c){if(b&&c){if(!a.datatables[b])throw new Error("not found datatable "+b);c(a.datatables[b])}},putDatatable:function(b,c){a.datatable(b,c)}};return b}}),angular.module("ui.neptune.service.formStore",[]).provider("nptFormStore",function(){this.formConfigs={},this.form=function(a,b){if(b||(b=a,a=b.name),!a)throw new Error("formly must have a name.");return b.name=a,this.formConfigs[a]=b,this},this.$get=function(){var a=this,b={form:function(b,c){b&&c&&c(a.formConfigs[b])},put:function(b,c){return a.form(b,c),this}};return b}}),angular.module("ui.neptune.service.resource",[]).provider("nptResource",function(){this.params={},this.header={},this.backendUrl="/service",this.cache={},this.originData={},this.setBackendUrl=function(a){this.backendUrl=a},this.$get=function(a){var b=this,c={post:function(c,d,e,f){d=d||{},angular.extend(d,b.params),a.post(b.backendUrl,{y9action:{name:c,params:d}}).success(function(a){if(b.originData=a,"100"===a.code){if(a.cache)for(var c in a.cache){var d=b.cache[c]||{};b.cache[c]=angular.extend(d,a.cache[c])}e&&e(a.data)}else f&&f(a)}).error(function(a){b.originData=a,f&&f(a)})},cache:function(a,c){return a||c?a&&!c?b.cache[a]:a&&c&&b.cache[a]?b.cache[a][c]:void 0:b.cache},originData:function(){return b.originData}};return c}}),angular.module("ui.neptune.validator.bizValidator",["ui.neptune.service.resource"]).directive("nptBizValidator",function(a,b,c,d,e){return{restrict:"A",require:"?ngModel",link:function(f,g,h,i){var j=h.nptBizValidatorOpts||{};i&&(i.$asyncValidators.bizvalidate=function(g,i){var k=h.ngModel,l={};k&&(l[k]=g),l.$value=g,l=angular.extend({},f,l),j=angular.isObject(j)?j:angular.fromJson(j);var m=d.getConfig(h.nptBizValidator)||{};j=e.extendConfig(m,j);var n=j.bizName,o=j.validator,p=j.bizParams,q=j.validExpression;if(q||(q={},q[h.ngModel]=h.ngModel),!n||!o)throw new Error("无效的nptBizValidator配置；"+(h.name||h.ngModel));var r=a.defer();return!n||!o||angular.isString(o)&&!c[o]||!angular.isString(o)&&!angular.isFunction(o)?(r.reject(new Error("无效的nptBizValidator配置；"+(h.name||h.ngModel))),r.promise):(p=e.parseParams(p,l),b.post(n,p,function(a){q=e.parseParams(q,l);var b=e.execute(o,a,q);b?r.resolve():r.reject()},function(a){r.reject(a)}),r.promise)},h.$observe("nptBizValidatorOpts",function(a){j=a?a:{},i.$validate()}))}}}).factory("nptBizValidatorHelper",function(a,b){return{extendConfig:function(a,b){return a.bizParams&&(a.bizParams=angular.extend(a.bizParams,b.bizParams||{}),delete b.bizParams),angular.extend(a,b)},parseParams:function(b,c){if(angular.isObject(b)){var d={};for(var e in b)d[e]=this.parseParams(b[e],c);return d}return angular.isDefined(b)?a(b)(c):void 0},execute:function(a,c,d){if(angular.isString(a))return b[a](c,d);if(angular.isFunction(a))return a(c,d);throw new Error("无法执行验证器："+a)}}}).service("nptBizValidatorService",function(a){this.exist=function(b,c){if(!b)return!1;if(!c)return angular.isArray(b)?b.length>0:!!b;var d=[];return d=angular.isString(c)?a("filter")(angular.isArray(b)?b:[b],c):a("filter")(angular.isArray(b)?b:[b],function(a,b,d){for(var e in c)if(c[e]!=a[e])return!1;return!0}),d&&d.length>0?!0:!1},this.noExist=function(a,b){return!this.exist(a,b)}}).provider("nptBizValidatorProvider",function(){var a={};this.addConfig=function(b,c){a[b]=c},this.$get=function(){return{getConfig:function(b){if(!b)return void 0;var c=a[b];return c?angular.copy(c):void 0}}}}).config(function(a){}),angular.module("ui.neptune.validator.number2date",[]).directive("nptNumber2date",function(){return{require:"ngModel",link:function(a,b,c,d){var e=function(a){var b=!1,c=a+"";if(a&&8===c.length){var e=c.substring(0,4)+"/"+c.substring(4,6)+"/"+c.substring(6,8),f=new Date(e);b=isNaN(f)?!1:!0}return d.$setValidity("nptNumber2date",b),a};d.$parsers.push(e),d.$formatters.push(e)}}}),angular.module("ui.neptune.filter.bizFilter",["ui.neptune.service.resource"]).directive("nptBizFilter",function(a,b,c){return{restrict:"A",require:"?ngModel",link:function(b,d,e,f){var g=e.nptBizFilter;if(!g)throw new Error("无效的指令器配置,"+e.ngModel);var h=g.split("|"),i=h[0]||e.ngModel,j=h[h.length-1].split(/\s+as\s+/),k=2==j.length?j[1]:e.ngModel;h[h.length-1]=2==j.length?j[0]:h[h.length-1],b.$watch(i,function(e,f){var g={};g.$value=e,g=angular.extend({},b,g),c.fire(a(h[0])(g),h.slice(1),g).then(function(c){if(k){var e=a(k).assign;e(b,c)}else c=angular.isObject(c)?angular.fromJson(c):c,$(d).html(c)},function(a){throw a})})}}}).service("nptBizFilterHelper",function(a,b,c,d,e){this.fire=function(b,c,d){var e=a.defer(),f=this,g=0,h=function(a){if(g==c.length)return void e.resolve(a);var b=c[g];f.filter(a,b,d).then(function(a){g++,h(a)},function(a){throw a})};return this.filter(b).then(function(a){h(a)}),e.promise},this.filter=function(c,e,f){var g=a.defer();if(!e)return g.resolve(c),g.promise;e=this.parseFilterExpression(e,f);var h=e.filterName,i=e.expression,j=d.getConfig(h);return j?this.doBizFilter(h,i,f):(g.resolve(b(h)(c,i)),g.promise)},this.doBizFilter=function(b,c,f){var g=a.defer();c=c||{},c=angular.isObject(c)?c:angular.fromJson(c);var h=d.getConfig(b);h.bizParams=h.bizParams||{},h.bizParams=this.linkContex(h.bizParams,f),angular.extend(h.bizParams,c);var i=this;return e.post(h.bizName,h.bizParams,function(a){h.chains?i.fire(a,h.chains,f).then(function(a){g.resolve(a)}):g.resolve(a)},function(a){g.reject(a)}),g.promise},this.linkContex=function(a,b){if(angular.isObject(a)){var d={};for(var e in a)d[e]=this.linkContex(a[e],b);return d}return this.quoteValueOfExpression(c(a)(b),b)},this.quoteValueOfExpression=function(a){if(!angular.isString(a))return a;var b={"!==":/!==\s*/,"===":/===\s*/,"==":/==\s*/,"<=":/<=\s*/,">=":/>=\s*/,"!=":/!=\s*/,"<":/<\s*/,">":/>\s*/,"=":/=\s*/};for(var c in b){var d=a.split(b[c]);if(2==d.length&&angular.isString(d[1])&&0!==d[1].indexOf('"')&&0!==d[1].indexOf("'"))return d[0]+c+'"'+d[1]+'"'}return a},this.parseFilterExpression=function(a,b){if(!a)return{};if(a.indexOf(":")>0){var c={};a=a.split(":");var d=a[0];return a=a.slice(1),a=a.join(":"),a=a.startsWith("{")?angular.fromJson(a):a,c.filterName=d,c.expression=this.linkContex(a,b),c}return{filterName:a}}}).filter("pickup",function(a){return function(b,c){var d=b;if(angular.isArray(b))d=b[0];else if(!angular.isObject(b))return d;return d=d||{},a(c)(d)}}).provider("nptBizFilterProvider",function(){var a={};this.addConfig=function(b,c){a[b]=c},this.$get=function(){return{getConfig:function(b){if(!b)return void 0;var c=a[b];return c?angular.copy(c):void 0}}}}).config(function(a){}),angular.module("ui.neptune.directive.datatable",["ui.bootstrap","formly","formlyBootstrap"]).constant("DatatableConfig",function(){return{currPage:1,maxSize:10,itemsPerPage:5,isIndex:!1,isPagination:!1}}).controller("datatableController",["$scope","$attrs","DatatableConfig","nptFormStore","$uibModal","$q","$injector",function(a,b,c,d,e,f,g){var h=this;a.controller&&(a.controller=this),this.$datatable={init:function(a,b){var d=this;if(this.header.init(a.header),this.action.init(a.action),d.page.init(c(),b),b.onAddListens)for(var e in b.onAddListens)this.putAddListen(b.onAddListens[e]);if(b.onDelListens)for(var f in b.onDelListens)this.putDelListen(b.onDelListens[f]);if(b.onEditListens)for(var g in b.onEditListens)this.putEditListen(b.onEditListens[g])},putAddListen:function(a){"function"==typeof a&&this.onAddListens.push(a)},putDelListen:function(a){"function"==typeof a&&this.onDelListens.push(a)},putEditListen:function(a){"function"==typeof a&&this.onEditListens.push(a)},onAddListens:[],onDelListens:[],onEditListens:[],handler:{add:function(b,c,d){var e=h.$forms.open(b.target,{});return e?e=e.then(function(c){var e={action:b,index:d,data:c},i=[];angular.forEach(h.$datatable.onAddListens,function(a){angular.isFunction(a)&&i.push(f.when(g.invoke(a,this,{params:e})))}),f.all(i).then(function(){a.data.push(e.data)},function(a){console.info("添加执行失败!"+JSON.stringify(a))})},function(a){console.info("添加操作取消")}):void 0},del:function(b,c,d){var e=f.defer(),i=e.promise,j={action:b,item:c,index:d};e.resolve(j),i.then(function(a){console.info("开始删除数据")},function(a){console.info("删除数据错误!"+a)});var k=[i];angular.forEach(h.$datatable.onDelListens,function(a){angular.isFunction(a)&&k.push(f.when(g.invoke(a,this,{params:j})))});var l=f.all(k).then(function(){a.data.splice(j.index,1)},function(a){console.info("删除失败!"+a)});return l},edit:function(a,b,c){var d=h.$forms.open(a.target,b);return d&&d.then(function(d){var e={action:a,index:c,data:d,item:angular.copy(b)},i=[];angular.forEach(h.$datatable.onEditListens,function(a){angular.isFunction(a)&&i.push(f.when(g.invoke(a,this,{params:e})))}),f.all(i).then(function(a){console.info("编辑操作成功!"),angular.extend(b,e.data)},function(a){console.info("编辑操作失败!")})},function(a){console.info("编辑操作取消")}),d},none:function(b,c,d){a.onAction&&a.onAction({action:b,item:c,index:d})}},header:{init:function(a){if(a)for(var b in a)this.items.push({name:b,label:a[b].label})},items:[]},action:{init:function(a){if(a)for(var b in a){var c={name:b,label:a[b].label,type:a[b].type||"none",target:a[b].target||void 0};this.items.push(c)}},items:[],onClick:function(a,b,c){h.$datatable.handler[a.type]&&h.$datatable.handler[a.type](a,b,c)}},page:{init:function(a,b){this.currPage=b.currPage||a.currPage,this.totalItems=0,b.data&&(this.totalItems=b.data.length||0),this.maxSize=a.maxSize,this.itemsPerPage=b.itemsPerPage||a.itemsPerPage,this.isIndex=b.isIndex||a.isIndex,this.isPagination=b.isPagination||a.isPagination},data:[],pageChange:function(a){this.data=[];var b=0,c=0;if(this.isPagination?(b=this.currPage*this.itemsPerPage,c=this.currPage*this.itemsPerPage-this.itemsPerPage):(c=0,b=0,a&&(b=a.length)),a)for(c;b>c&&!(c>=a.length);c++)this.data.push(a[c])}}},a.datatable=this.$datatable,this.$forms={init:function(){},open:function(a,b){this.originData=b;var c={};angular.copy(b,c);var f=e.open({animation:!0,templateUrl:"/template/datatable/datatable-edit.html",controller:"editDatatableController",controllerAs:"vm",resolve:{formData:function(b){var e=b.defer();return d.form(a,function(a){e.resolve({fields:a.fields,model:c,options:a.options})}),e.promise}}}).result;return f},close:function(){e.close()}},a.forms=this.$forms}]).controller("editDatatableController",function(a,b){function c(){a.close(e.formData.model)}function d(){a.dismiss("cancel")}var e=this;e.ok=c,e.cancel=d,e.formData=b,e.originalFields=angular.copy(e.formData.fields)}).directive("nptDatatable",["$parse","nptDatatableStore",function(a,b){return{restrict:"E",controller:"datatableController",transclude:!0,replace:!0,templateUrl:function(a,b){return b.templateUrl||"/template/datatable/datatable.html"},scope:{name:"@",options:"=?",data:"=",isIndex:"=?",isPagination:"@",itemsPerPage:"=?",controller:"=",onAction:"&",onAddListens:"=",onEditListens:"=",onDelListens:"="},link:function(c,d,e,f){if(c.options?f.$datatable.init(c.options,c):b.datatable(c.name,function(a){f.$datatable.init(a,c)}),f.$forms.init(),c.$watchCollection("data",function(a,b){angular.isDefined(a)&&null!==a&&(f.$datatable.page.totalItems=a.length,f.$datatable.page.pageChange(c.data))}),c.$watch("datatable.page.currPage",function(a,b){f.$datatable.page.pageChange(c.data)}),e.name&&c.$parent){var g=a(e.name).assign;g(c.$parent,f)}}}}]),angular.module("ui.neptune.directive.form",[]).controller("FormControllect",["$scope",function(a){this.init=function(){},a.doAction=function(b){angular.isDefined(a.onClickAction)&&a.onClickAction({item:b})},a.doSave=function(){console.info("保存表单")},a.doReset=function(){console.info("重置表单")}}]).directive("nptForm",[function(){return{restrict:"E",controller:"FormControllect",replace:!0,templateUrl:function(a,b){return b.templateUrl||"/template/form/form.html"},scope:{model:"=?",data:"=",onClickAction:"&",onSave:"&",onReset:"&"},compile:function(a){return{pre:function(a,b,c,d){},post:function(a,b,c,d){}}}}}]),angular.module("ui.neptune.directive.selectTree",["ui.bootstrap","ui.tree"]).provider("SelectTreeConfig",function(){this.treeHandler={},this.listHandler={},this.defaultListHeader=[{name:"name",label:"姓名"}],this.listHeader={},this.defaultListAction=[{name:"select",label:"选择"}],this.listAction={},this.setTreeHandler=function(a,b){a&&b&&(this.treeHandler[a]=b)},this.setListHandler=function(a,b){a&&b&&(this.listHandler[a]=b)},this.$get=function(a){var b=this,c={treeData:function(c,d){b.treeHandler[c]&&d&&b.treeHandler[c](a,d)},listData:function(c,d,e){b.listHandler[c]&&e&&b.listHandler[c](a,d,e)},listHeader:function(a){return b.listHeader[a]?b.listHeader[a]:b.defaultListHeader},listAction:function(a){return b.listAction[a]?b.listAction[a]:b.defaultListAction}};return c}}).controller("SelectTreeController",["$scope","nptResource",function(a){this.init=function(b){a.element=b,a.modalElement=$(b).find(".modal")},this.close=function(){a.modalElement.modal("hide")},this.open=function(){a.modalElement.modal("show")}}]).directive("nptSelectTree",["$parse","SelectTreeConfig",function(a,b){return{restrict:"E",controller:"SelectTreeController",transclude:!0,replace:!0,templateUrl:function(a,b){return b.templateUrl||"/template/select-tree/select-tree.html"},scope:{onSelect:"&",selectType:"@"},link:function(c,d,e,f){if(f.init(d),c.close=f.close,c.listHeader=b.listHeader(c.selectType),c.listAction=b.listAction(c.selectType),b.treeData(c.selectType,function(a){c.treeData=a}),c.onTreeClick=function(a){console.info("点击tree"),b.listData(c.selectType,a.id,function(a){c.listData=a})},c.onListSelect=function(a,b,d){console.info("点击list"),c.onSelect&&c.onSelect({type:a,item:b,index:d}),f.close()},e.name&&c.$parent){var g=a(e.name).assign;g(c.$parent,f)}}}}]),angular.module("ui.neptune.tpls",["/template/datatable/datatable-edit.html","/template/datatable/datatable.html","/template/form/form.html","/template/select-tree/select-tree.html"]),angular.module("/template/datatable/datatable-edit.html",[]).run(["$templateCache",function(a){a.put("/template/datatable/datatable-edit.html",'<div><div class="modal-header"><button type="button" ng-click="vm.cancel()" aria-label="关闭" class="close"><span>&times</span></button><h4 class="modal-title">编辑</h4></div><div class="modal-body"><formly-form model="vm.formData.model" fields="vm.formData.fields" form="vm.form"></formly-form></div><div class="modal-footer"><button type="button" ng-click="vm.ok()" class="btn btn-primary">确定</button><button type="button" ng-click="vm.cancel()" class="btn btn-warning">取消</button></div></div>')}]),angular.module("/template/datatable/datatable.html",[]).run(["$templateCache",function(a){a.put("/template/datatable/datatable.html",'<div><div class="col-md-12"><!-- 设置为响应式表格 当页面宽度不够显示表格内容时会出现滚动条--><div class="table-responsive"><!-- table-striped表示隔行显示不同颜色条纹；table-hover鼠标悬停变色；table-bordered表格线框;table-condensed紧缩表格--><table class="table table-striped table-bordered table-hover table-condensed"><tfoot><tr ng-show="isPagination"><td colspan="50"><uib-pagination style="margin:0px;" total-items="datatable.page.totalItems" ng-model="datatable.page.currPage" items-per-page="datatable.page.itemsPerPage" max-size="datatable.page.maxSize" boundary-links="true" first-text="首页" previous-text="上一页" next-text="下一页" last-text="尾页" class="pagination-sm"></uib-pagination></td></tr></tfoot><thead><tr ng-show="isPagination"><td colspan="50"><uib-pagination style="margin:0px;" total-items="datatable.page.totalItems" ng-model="datatable.page.currPage" items-per-page="datatable.page.itemsPerPage" max-size="datatable.page.maxSize" boundary-links="true" first-text="首页" previous-text="上一页" next-text="下一页" last-text="尾页" class="pagination-sm"></uib-pagination></td></tr><tr><th ng-if="datatable.page.isIndex" class="text-center">&#24207;&#21495;</th><th ng-repeat="item in datatable.header.items" class="text-center">{{item.label}}</th><th ng-if="datatable.action.items.length&gt;0" class="text-center">&#25805;&#20316;</th></tr></thead><tbody><tr ng-repeat="item in datatable.page.data"><td ng-if="datatable.page.isIndex" class="text-center">{{($index+1)+(datatable.page.currPage * datatable.page.itemsPerPage - datatable.page.itemsPerPage)}}</td><td ng-repeat="headerItem in datatable.header.items">{{item[headerItem.name]}}</td><td ng-if="datatable.action.items.length&gt;0"><a ng-repeat="actionItem in datatable.action.items" href="" ng-click="datatable.action.onClick(actionItem,item,datatable.page.currPage * datatable.page.itemsPerPage - datatable.page.itemsPerPage + $parent.$index)" class="btn btn-primary btn-xs">{{actionItem.label}}</a></td></tr></tbody></table></div></div></div>')}]),angular.module("/template/form/form.html",[]).run(["$templateCache",function(a){a.put("/template/form/form.html","<div></div>")}]),angular.module("/template/select-tree/select-tree.html",[]).run(["$templateCache",function(a){a.put("/template/select-tree/select-tree.html",'<div><div id="treeSelect" tabindex="-1" role="dialog" class="modal fade"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><button type="button" ng-click="close()" aria-label="关闭" class="close"><span>&times</span></button><h4 class="modal-title">选择用户</h4></div><div class="modal-body"><div class="row"><div class="col-md-4"><div ui-tree id="tree-root" data-drag-enabled="false"><ol ui-tree-nodes ng-model="treeData"><li ng-repeat="node in treeData" ui-tree-node ng-include="\'org_nodes.html\'"></li></ol></div></div><div class="col-md-8"><npt-datatable name="listSelect" is-pagination="true" items-per-page="5" header="listHeader" action="listAction" data="listData" is-index="true" on-action="onListSelect(type,item,index)"></npt-datatable></div></div></div><div class="modal-footer"><button ng-click="close()" class="btn btn-default">关闭</button></div></div></div></div><script type="text/ng-template" id="org_nodes.html"><div ui-tree-handle class="tree-node tree-node-content"><a ng-if="node.nodes &amp;&amp; node.nodes.length &gt; 0" ng-click="toggle(this)" class="btn btn-success btn-xs"><span ng-class="{\'glyphicon-chevron-right\': collapsed,\'glyphicon-chevron-down\': !collapsed}" class="glyphicon"></span></a>&nbsp &nbsp<a ng-click="onTreeClick(node)" class="btn-link">{{node.title}}</a></div><ol ui-tree-nodes="" ng-model="node.nodes" ng-class="{hidden:collapsed}"><li ng-repeat="node in node.nodes" ui-tree-node ng-include="\'org_nodes.html\'"></li></ol></script></div>')}]);